#!/usr/bin/env ts-node
/**
 * Auto-generate `src/generated/posts.ts` containing typed meta for blog posts.
 * Run via `pnpm run generate:posts` (called in dev/build scripts).
 */
import { execSync } from 'node:child_process';
import fs from 'node:fs';
import path from 'node:path';
import fg from 'fast-glob';
import matter from 'gray-matter';

const __dirname = import.meta.dirname;

const POSTS_DIR = path.resolve(__dirname, '../src/posts');
const OUTPUT_DIR = path.resolve(__dirname, '../src/generated');
const OUTPUT_FILE = path.join(OUTPUT_DIR, 'posts.ts');

interface FrontMatter {
  date: string; // ISO string
  summary?: string;
  tags?: string[];
  title: string;
}

interface PostMeta extends FrontMatter {
  path: string;
  slug: string;
}

async function main() {
  if (!fs.existsSync(POSTS_DIR)) {
    console.warn(
      `‚ö†Ô∏è  Posts directory ${POSTS_DIR} not found. Skipping index generation.`,
    );
    return;
  }

  const entries = await fg(['**/*.mdx', '**/*.md'], { cwd: POSTS_DIR });
  const posts: PostMeta[] = [];

  for (const rel of entries) {
    const abs = path.join(POSTS_DIR, rel);
    const src = fs.readFileSync(abs, 'utf8');
    const { data } = matter(src);
    const front = data as Partial<FrontMatter>;

    if (!front.title || !front.date) {
      console.warn(
        `Skipping ${rel} ‚Äì missing required front-matter (title/date).`,
      );
      continue;
    }

    const slug = rel.replace(/\.(mdx|md)$/, '');

    posts.push({
      date: front.date,
      path: `/blog/${slug}`,
      slug,
      summary: front.summary ?? '',
      tags: front.tags ?? [],
      title: front.title,
    });
  }

  // Sort newest first
  posts.sort((a, b) => (a.date < b.date ? 1 : -1));

  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  const banner = `// This file is auto-generated by scripts/generatePostIndex.ts ‚Äì DO NOT EDIT\n`;
  const typeDef = `export type PostMeta = {\n  date: string;\n  path: string;\n  slug: string;\n  summary?: string;\n  tags?: string[];\n  title: string;\n};\n\n`;
  const array = `export const posts: PostMeta[] = ${JSON.stringify(posts, null, 2)};\n`;

  fs.writeFileSync(OUTPUT_FILE, banner + '\n' + typeDef + array, 'utf8');

  // Format the generated file with Prettier
  try {
    execSync(`npx prettier --write "${OUTPUT_FILE}"`, { stdio: 'inherit' });
  } catch (error) {
    console.warn('Failed to format generated file with Prettier:', error);
  }

  console.log(
    `üìù Generated ${posts.length} post meta ‚Üí ${path.relative(process.cwd(), OUTPUT_FILE)}`,
  );
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
